C51 COMPILER V8.02   SMARTCAR                                                              02/01/2018 15:02:12 PAGE 1   


C51 COMPILER V8.02, COMPILATION OF MODULE SMARTCAR
OBJECT MODULE PLACED IN SmartCar.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE SmartCar.c BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /*---------------------------------------------------------------------*/
   2          /* --- STC MCU Limited ------------------------------------------------*/
   3          /* --- STC15F4K60S4 ÏµÁÐ ¶¨Ê±Æ÷1ÓÃ×÷´®¿Ú1µÄ²¨ÌØÂÊ·¢ÉúÆ÷¾ÙÀý------------*/
   4          /* --- Mobile: (86)13922805190 ----------------------------------------*/
   5          /* --- Fax: 86-0513-55012956,55012947,55012969 ------------------------*/
   6          /* --- Tel: 86-0513-55012928,55012929,55012966-------------------------*/
   7          /* --- Web: www.STCMCU.com --------------------------------------------*/
   8          /* --- Web: www.GXWMCU.com --------------------------------------------*/
   9          /* Èç¹ûÒªÔÚ³ÌÐòÖÐÊ¹ÓÃ´Ë´úÂë,ÇëÔÚ³ÌÐòÖÐ×¢Ã÷Ê¹ÓÃÁËSTCµÄ×ÊÁÏ¼°³ÌÐò        */
  10          /* Èç¹ûÒªÔÚÎÄÕÂÖÐÓ¦ÓÃ´Ë´úÂë,ÇëÔÚÎÄÕÂÖÐ×¢Ã÷Ê¹ÓÃÁËSTCµÄ×ÊÁÏ¼°³ÌÐò        */
  11          /*---------------------------------------------------------------------*/
  12          
  13          //±¾Ê¾ÀýÔÚKeil¿ª·¢»·¾³ÏÂÇëÑ¡ÔñIntelµÄ8058Ð¾Æ¬ÐÍºÅ½øÐÐ±àÒë
  14          //ÈôÎÞÌØ±ðËµÃ÷,¹¤×÷ÆµÂÊÒ»°ãÎª11.0592MHz
  15          
  16          
  17          #include "STC15W4K58S4.h"
  18          
  19          #include "intrins.h"
  20          #include <string.h>  // ×Ö·û´®´¦ÀíÍ·ÎÄ¼þ
  21          
  22          sbit LED = P3 ^ 2;  // ¶ÔÓ¦Ó²¼þÁ¬½Ó
  23          sbit LOUND = P5 ^ 4;  // ¶ÔÓ¦Ó²¼þÁ¬½Ó
  24          
  25          bit busy;
  26          
  27          typedef unsigned char BYTE;
  28          typedef unsigned int WORD;
  29          
  30          BYTE DATA_LENGTH = 7;
  31          BYTE CURRENT_LENGTH=0;
  32          
  33          BYTE DATA_SEND[]= { 0x7E, 0x00,     0,  0,      0,      0,       0x7E};
  34          BYTE DATA_GET[]=  { 0x7E, 0x00,     0,  0,      0,      0,       0x7E};
  35          
  36          
  37          #define FOSC 11059200L          //ÏµÍ³ÆµÂÊ
  38          #define BAUD 115200             //´®¿Ú²¨ÌØÂÊ
  39          
  40          #define S1_S0 0x40              //P_SW1.6
  41          #define S1_S1 0x80              //P_SW1.7
  42          
  43          
  44          
  45          void SendData(char *s);
  46          void UART_TC (unsigned char *str);
  47          void UART_T (unsigned char UART_data); //¶¨Òå´®¿Ú·¢ËÍÊý¾Ý±äÁ¿
  48          void UART_R();//½ÓÊÜÊý¾Ý
  49          void DELAY_MS(unsigned int timeout);    //@11.0592MHz   1ms
  50          void ConnectServer();//Á¬½Ó·þÎñÆ÷
  51          void USART_Init();
  52          void Device_Init();
  53          void ResponseData(unsigned char *RES_DATA);
  54          char CheckData(unsigned char *CHECK_DATA);
  55          
C51 COMPILER V8.02   SMARTCAR                                                              02/01/2018 15:02:12 PAGE 2   

  56          
  57          void main()
  58          {
  59   1      
  60   1          Device_Init();
  61   1      
  62   1          USART_Init();
  63   1      
  64   1          DELAY_MS(1000);
  65   1      
  66   1          ConnectServer();
  67   1      
  68   1          while(1) {
  69   2      
  70   2              //  DELAY_MS(2000);
  71   2              //  SendString(DATA_GET);
  72   2      
  73   2          };
  74   1      }
  75          
  76          
  77          void Device_Init() {
  78   1      
  79   1          LED = 0;
  80   1          LOUND = 0;
  81   1      }
  82          
  83          
  84          void USART_Init()
  85          {
  86   1      
  87   1      //   ACC = P_SW1;
  88   1      //    ACC &= ~(S1_S0 | S1_S1);    //S1_S0=0 S1_S1=0
  89   1      //    P_SW1 = ACC;                //(P3.0/RxD, P3.1/TxD)
  90   1      
  91   1          ACC = P_SW1;
  92   1          ACC &= ~(S1_S0 | S1_S1);    //S1_S0=1 S1_S1=0
  93   1          ACC |= S1_S0;               //(P3.6/RxD_2, P3.7/TxD_2)
  94   1          P_SW1 = ACC;
  95   1          SCON = 0x50;                //8Î»¿É±ä²¨ÌØÂÊ
  96   1      
  97   1      //  ACC = P_SW1;
  98   1      //  ACC &= ~(S1_S0 | S1_S1);    //S1_S0=0 S1_S1=1
  99   1      //  ACC |= S1_S1;               //(P1.6/RxD_3, P1.7/TxD_3)
 100   1      //  P_SW1 = ACC;
 101   1      
 102   1      
 103   1          AUXR = 0x40;                //¶¨Ê±Æ÷1Îª1TÄ£Ê½
 104   1          TMOD = 0x00;                //¶¨Ê±Æ÷1ÎªÄ£Ê½0(16Î»×Ô¶¯ÖØÔØ)
 105   1          TL1 = (65536 - (FOSC/4/BAUD));   //ÉèÖÃ²¨ÌØÂÊÖØ×°Öµ
 106   1          TH1 = (65536 - (FOSC/4/BAUD))>>8;
 107   1          TR1 = 1;                    //¶¨Ê±Æ÷1¿ªÊ¼Æô¶¯
 108   1          ES = 1;                     //Ê¹ÄÜ´®¿ÚÖÐ¶Ï
 109   1          EA = 1;
 110   1      
 111   1      }
 112          
 113          /*----------------------------
 114          UART ÖÐ¶Ï·þÎñ³ÌÐò
 115          -----------------------------*/
 116          void Uart() interrupt 4 using 1
 117          {
C51 COMPILER V8.02   SMARTCAR                                                              02/01/2018 15:02:12 PAGE 3   

 118   1          if (RI)
 119   1          {
 120   2              while(!RI);
 121   2              RI=0;
 122   2              UART_R();
 123   2              busy = 0;
 124   2      
 125   2          }
 126   1          if (TI)
 127   1          {
 128   2              while(!TI);
 129   2              TI = 0;                 //Çå³ýTIÎ»
 130   2              busy = 0;               //ÇåÃ¦±êÖ¾
 131   2          }
 132   1      }
 133          
 134          
 135          /*----------------------------
 136          ·¢ËÍ´®¿ÚÊý¾Ý
 137          ----------------------------*/
 138          
 139          void  SendData(char *s)
 140          {
 141   1      
 142   1          unsigned int i=0;
 143   1          while (busy);               //µÈ´ýÇ°ÃæµÄÊý¾Ý·¢ËÍÍê³É
 144   1      
 145   1          for(i=0; i<DATA_LENGTH; i++)
 146   1          {
 147   2              SBUF=s[i];
 148   2              while(!TI);
 149   2              TI=0;
 150   2          }
 151   1      }
 152          
 153          void UART_T (unsigned char UART_data) { //¶¨Òå´®¿Ú·¢ËÍÊý¾Ý±äÁ¿
 154   1          SBUF = UART_data; //½«½ÓÊÕµÄÊý¾Ý·¢ËÍ»ØÈ¥
 155   1          while(TI == 0);   //¼ì²é·¢ËÍÖÐ¶Ï±êÖ¾Î»
 156   1          TI = 0;     //Áî·¢ËÍÖÐ¶Ï±êÖ¾Î»Îª0£¨Èí¼þÇåÁã£©
 157   1      }
 158          
 159          
 160          void UART_TC (unsigned char *str) {
 161   1          while(*str != '\0') {
 162   2              UART_T(*str);
 163   2              str++;
 164   2          }
 165   1          *str = 0;
 166   1      }
 167          
 168          
 169          //´®¿Ú  ½ÓÊÕµ½µÄÊý¾Ý
 170          
 171          void UART_R()
 172          {
 173   1          DATA_GET[CURRENT_LENGTH]=SBUF;
 174   1          CURRENT_LENGTH++;
 175   1          if(CURRENT_LENGTH==DATA_LENGTH)
 176   1          {
 177   2              CURRENT_LENGTH=0;
 178   2              ResponseData(DATA_GET);
 179   2          }
C51 COMPILER V8.02   SMARTCAR                                                              02/01/2018 15:02:12 PAGE 4   

 180   1      }
 181          
 182          
 183          
 184          char CheckData(unsigned char *CHECK_DATA) {
 185   1      
 186   1        unsigned char  CHECKSUM = CHECK_DATA[1]+CHECK_DATA[2]+CHECK_DATA[3]+CHECK_DATA[4]-0x01;
 187   1              
 188   1        unsigned char SUM= CHECK_DATA[5];
 189   1        
 190   1        if(CHECKSUM == SUM){
 191   2            return 1;
 192   2        }
 193   1        return 0;
 194   1      
 195   1      }
 196          
 197          
 198          
 199          void ResponseData(unsigned char *RES_DATA) {
 200   1        
 201   1        if(CheckData(RES_DATA)){
 202   2          
 203   2          if(RES_DATA[1]==0x03 && RES_DATA[4]==0x02) {
 204   3              LED = 1;
 205   3          } else  if(RES_DATA[1]==0x03 && RES_DATA[4]==0x01) {
 206   3              LED = 0;
 207   3          } else if(RES_DATA[1]==0x02 && RES_DATA[4]==0x02) {
 208   3              LOUND = 1;
 209   3          } else  if(RES_DATA[1]==0x02 && RES_DATA[4]==0x01) {
 210   3              LOUND = 0;
 211   3          }
 212   2      
 213   2          SendData(DATA_GET);
 214   2      
 215   2        }
 216   1      
 217   1      }
 218          
 219          
 220          
 221          void DELAY_1MS() {
 222   1          unsigned char i, j;
 223   1      
 224   1          _nop_();
 225   1          _nop_();
 226   1          _nop_();
 227   1          i = 11;
 228   1          j = 190;
 229   1          do
 230   1          {
 231   2              while (--j);
 232   2          } while (--i);
 233   1      
 234   1      
 235   1      }
 236          
 237          void DELAY_MS(unsigned int timeout)   //@11.0592MHz
 238          {
 239   1          int t = 0;
 240   1          while (t < timeout)
 241   1          {
C51 COMPILER V8.02   SMARTCAR                                                              02/01/2018 15:02:12 PAGE 5   

 242   2              t++;
 243   2              DELAY_1MS();
 244   2          }
 245   1      }
 246          
 247          
 248          void ConnectServer() {
 249   1      
 250   1      
 251   1          UART_TC("+++\0"); // ÍË³öÍ¸´«Ä£Ê½
 252   1          DELAY_MS( 1500);
 253   1      
 254   1          UART_TC("AT\r\n\0");  // ATÖ¸Áî²âÊÔ
 255   1          DELAY_MS(1500);
 256   1      
 257   1          //UART_TC("AT+CWSTARTSMART\r\n\0"); // ¿ªÊ¼ÖÇÄÜÅäÍøÄ£Ê½
 258   1          //DELAY_MS(1000);
 259   1      //  LED = 0; // ÅäÍøÖ¸Ê¾µÆÁÁÆð
 260   1      //  DELAY_MS( 30000); // Á´½Ó³É¹¦
 261   1      
 262   1          //UART_TC("AT+CWSTOPSMART\r\n\0"); // ½áÊøÖÇÄÜÅäÍøÄ£Ê½£¬ÊÍ·ÅÄ£¿é×ÊÔ´(±ØÐë)
 263   1      //  DELAY_MS( 1000);
 264   1          //LED = 1; // ÅäÍøÖ¸Ê¾µÆÏ¨Ãð
 265   1      
 266   1          UART_TC("AT+CIPMUX=0\r\n\0");  // ÉèÖÃµ¥Á¬½ÓÄ£Ê½
 267   1          DELAY_MS(1500);
 268   1      
 269   1          UART_TC("AT+CIPSTART=\"TCP\",\"192.168.0.104\",4001\r\n\0");  // Á¬½Óµ½Ö¸¶¨TCP·þÎñÆ÷
 270   1          DELAY_MS( 3500);
 271   1      
 272   1          UART_TC("AT+CIPMODE=1\r\n\0"); // ÉèÖÃÍ¸´«Ä£Ê½
 273   1          DELAY_MS( 1500);
 274   1      
 275   1          UART_TC("AT+SAVETRANSLINK=1,\"192.168.0.104\",4001,\"TCP\"\r\n\0"); // ±£´æTCPÁ¬½Óµ½flash£¬ÊµÏÖÉÏµçÍ¸´
             -«
 276   1          DELAY_MS(1500);
 277   1      
 278   1          UART_TC("AT+CIPSEND\r\n\0");   // ½øÈëÍ¸´«Ä£Ê½
 279   1          DELAY_MS( 1500);
 280   1      
 281   1          CURRENT_LENGTH=0;
 282   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    481    ----
   CONSTANT SIZE    =    147    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     16       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
