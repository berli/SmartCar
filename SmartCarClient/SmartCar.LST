C51 COMPILER V8.02   SMARTCAR                                                              02/01/2018 15:38:44 PAGE 1   


C51 COMPILER V8.02, COMPILATION OF MODULE SMARTCAR
OBJECT MODULE PLACED IN SmartCar.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE SmartCar.c BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /*---------------------------------------------------------------------*/
   2          /* --- STC MCU Limited ------------------------------------------------*/
   3          /* --- STC15F4K60S4 ÏµÁÐ ¶¨Ê±Æ÷1ÓÃ×÷´®¿Ú1µÄ²¨ÌØÂÊ·¢ÉúÆ÷¾ÙÀý------------*/
   4          /* --- Mobile: (86)13922805190 ----------------------------------------*/
   5          /* --- Fax: 86-0513-55012956,55012947,55012969 ------------------------*/
   6          /* --- Tel: 86-0513-55012928,55012929,55012966-------------------------*/
   7          /* --- Web: www.STCMCU.com --------------------------------------------*/
   8          /* --- Web: www.GXWMCU.com --------------------------------------------*/
   9          /* Èç¹ûÒªÔÚ³ÌÐòÖÐÊ¹ÓÃ´Ë´úÂë,ÇëÔÚ³ÌÐòÖÐ×¢Ã÷Ê¹ÓÃÁËSTCµÄ×ÊÁÏ¼°³ÌÐò        */
  10          /* Èç¹ûÒªÔÚÎÄÕÂÖÐÓ¦ÓÃ´Ë´úÂë,ÇëÔÚÎÄÕÂÖÐ×¢Ã÷Ê¹ÓÃÁËSTCµÄ×ÊÁÏ¼°³ÌÐò        */
  11          /*---------------------------------------------------------------------*/
  12          
  13          //±¾Ê¾ÀýÔÚKeil¿ª·¢»·¾³ÏÂÇëÑ¡ÔñIntelµÄ8058Ð¾Æ¬ÐÍºÅ½øÐÐ±àÒë
  14          //ÈôÎÞÌØ±ðËµÃ÷,¹¤×÷ÆµÂÊÒ»°ãÎª11.0592MHz
  15          
  16          
  17          #include "STC15W4K58S4.h"
  18          
  19          #include "intrins.h"
  20          #include <string.h>  // ×Ö·û´®´¦ÀíÍ·ÎÄ¼þ
  21          
  22          sbit LED = P3 ^ 2;  // ¶ÔÓ¦Ó²¼þÁ¬½Ó
  23          sbit LOUND = P5 ^ 4;  // ¶ÔÓ¦Ó²¼þÁ¬½Ó
  24          
  25          bit busy;
  26          
  27          typedef unsigned char BYTE;
  28          typedef unsigned int WORD;
  29          
  30          BYTE DATA_LENGTH = 7;
  31          BYTE CURRENT_LENGTH=0;
  32          
  33          BYTE DATA_GET[]=  { 0x7E, 0x00,     0,  0,      0,      0,       0x7E};
  34          
  35          
  36          #define FOSC 11059200L          //ÏµÍ³ÆµÂÊ
  37          #define BAUD 115200             //´®¿Ú²¨ÌØÂÊ
  38          
  39          #define S1_S0 0x40              //P_SW1.6
  40          #define S1_S1 0x80              //P_SW1.7
  41          
  42          
  43          
  44          void SendData(char *s);
  45          void UART_TC (unsigned char *str);
  46          void UART_T (unsigned char UART_data); //¶¨Òå´®¿Ú·¢ËÍÊý¾Ý±äÁ¿
  47          void UART_R();//½ÓÊÜÊý¾Ý
  48          void DELAY_MS(unsigned int timeout);    //@11.0592MHz   1ms
  49          void ConnectServer();//Á¬½Ó·þÎñÆ÷
  50          void USART_Init();
  51          void Device_Init();
  52          void ResponseData(unsigned char *RES_DATA);
  53          char CheckData(unsigned char *CHECK_DATA);
  54          void sendAckData(unsigned char *RES_DATA);
  55          
C51 COMPILER V8.02   SMARTCAR                                                              02/01/2018 15:38:44 PAGE 2   

  56          
  57          void main()
  58          {
  59   1      
  60   1          Device_Init();
  61   1      
  62   1          USART_Init();
  63   1      
  64   1          DELAY_MS(1000);
  65   1      
  66   1          ConnectServer();
  67   1      
  68   1          while(1) {
  69   2      
  70   2              //  DELAY_MS(2000);
  71   2              //  SendString(DATA_GET);
  72   2      
  73   2          };
  74   1      }
  75          
  76          
  77          void Device_Init() {
  78   1      
  79   1          LED = 0;
  80   1          LOUND = 0;
  81   1      }
  82          
  83          
  84          void USART_Init()
  85          {
  86   1      
  87   1      //   ACC = P_SW1;
  88   1      //    ACC &= ~(S1_S0 | S1_S1);    //S1_S0=0 S1_S1=0
  89   1      //    P_SW1 = ACC;                //(P3.0/RxD, P3.1/TxD)
  90   1      
  91   1          ACC = P_SW1;
  92   1          ACC &= ~(S1_S0 | S1_S1);    //S1_S0=1 S1_S1=0
  93   1          ACC |= S1_S0;               //(P3.6/RxD_2, P3.7/TxD_2)
  94   1          P_SW1 = ACC;
  95   1          SCON = 0x50;                //8Î»¿É±ä²¨ÌØÂÊ
  96   1      
  97   1      //  ACC = P_SW1;
  98   1      //  ACC &= ~(S1_S0 | S1_S1);    //S1_S0=0 S1_S1=1
  99   1      //  ACC |= S1_S1;               //(P1.6/RxD_3, P1.7/TxD_3)
 100   1      //  P_SW1 = ACC;
 101   1      
 102   1      
 103   1          AUXR = 0x40;                //¶¨Ê±Æ÷1Îª1TÄ£Ê½
 104   1          TMOD = 0x00;                //¶¨Ê±Æ÷1ÎªÄ£Ê½0(16Î»×Ô¶¯ÖØÔØ)
 105   1          TL1 = (65536 - (FOSC/4/BAUD));   //ÉèÖÃ²¨ÌØÂÊÖØ×°Öµ
 106   1          TH1 = (65536 - (FOSC/4/BAUD))>>8;
 107   1          TR1 = 1;                    //¶¨Ê±Æ÷1¿ªÊ¼Æô¶¯
 108   1          ES = 1;                     //Ê¹ÄÜ´®¿ÚÖÐ¶Ï
 109   1          EA = 1;
 110   1      
 111   1      }
 112          
 113          /*----------------------------
 114          UART ÖÐ¶Ï·þÎñ³ÌÐò
 115          -----------------------------*/
 116          void Uart() interrupt 4 using 1
 117          {
C51 COMPILER V8.02   SMARTCAR                                                              02/01/2018 15:38:44 PAGE 3   

 118   1          if (RI)
 119   1          {
 120   2              while(!RI);
 121   2              RI=0;
 122   2              UART_R();
 123   2              busy = 0;
 124   2      
 125   2          }
 126   1          if (TI)
 127   1          {
 128   2              while(!TI);
 129   2              TI = 0;                 //Çå³ýTIÎ»
 130   2              busy = 0;               //ÇåÃ¦±êÖ¾
 131   2          }
 132   1      }
 133          
 134          
 135          /*----------------------------
 136          ·¢ËÍ´®¿ÚÊý¾Ý
 137          ----------------------------*/
 138          
 139          void  SendData(char *s)
 140          {
 141   1      
 142   1          unsigned int i=0;
 143   1          while (busy);               //µÈ´ýÇ°ÃæµÄÊý¾Ý·¢ËÍÍê³É
 144   1      
 145   1          for(i=0; i<DATA_LENGTH; i++)
 146   1          {
 147   2              SBUF=s[i];
 148   2              while(!TI);
 149   2              TI=0;
 150   2          }
 151   1      }
 152          
 153          void UART_T (unsigned char UART_data) { //¶¨Òå´®¿Ú·¢ËÍÊý¾Ý±äÁ¿
 154   1          SBUF = UART_data; //½«½ÓÊÕµÄÊý¾Ý·¢ËÍ»ØÈ¥
 155   1          while(TI == 0);   //¼ì²é·¢ËÍÖÐ¶Ï±êÖ¾Î»
 156   1          TI = 0;     //Áî·¢ËÍÖÐ¶Ï±êÖ¾Î»Îª0£¨Èí¼þÇåÁã£©
 157   1      }
 158          
 159          
 160          void UART_TC (unsigned char *str) {
 161   1          while(*str != '\0') {
 162   2              UART_T(*str);
 163   2              str++;
 164   2          }
 165   1          *str = 0;
 166   1      }
 167          
 168          
 169          //´®¿Ú  ½ÓÊÕµ½µÄÊý¾Ý
 170          
 171          void UART_R()
 172          {
 173   1          DATA_GET[CURRENT_LENGTH]=SBUF;
 174   1          CURRENT_LENGTH++;
 175   1          if(CURRENT_LENGTH==DATA_LENGTH)
 176   1          {
 177   2              CURRENT_LENGTH=0;
 178   2              ResponseData(DATA_GET);
 179   2          }
C51 COMPILER V8.02   SMARTCAR                                                              02/01/2018 15:38:44 PAGE 4   

 180   1      }
 181          
 182          
 183          
 184          char CheckData(unsigned char *CHECK_DATA) {
 185   1      
 186   1          unsigned char  CHECKSUM = CHECK_DATA[1]+CHECK_DATA[2]+CHECK_DATA[3]+CHECK_DATA[4]-0x01;
 187   1          
 188   1          return CHECKSUM;
 189   1      
 190   1      }
 191          
 192          
 193          
 194          void ResponseData(unsigned char *RES_DATA) {
 195   1      
 196   1          if(CheckData(RES_DATA) == RES_DATA[5]) {
 197   2      
 198   2              if(RES_DATA[1]==0x03 && RES_DATA[4]==0x02) {
 199   3                  LED = 1;
 200   3                  sendAckData(RES_DATA);
 201   3              } else  if(RES_DATA[1]==0x03 && RES_DATA[4]==0x01) {
 202   3                  LED = 0;
 203   3                  sendAckData(RES_DATA);
 204   3              } else if(RES_DATA[1]==0x02 && RES_DATA[4]==0x02) {
 205   3                  LOUND = 1;
 206   3                  sendAckData(RES_DATA);
 207   3              } else  if(RES_DATA[1]==0x02 && RES_DATA[4]==0x01) {
 208   3                  LOUND = 0;
 209   3                  sendAckData(RES_DATA);
 210   3              }
 211   2      
 212   2              SendData(DATA_GET);
 213   2          }
 214   1      
 215   1      }
 216          
 217          
 218          void sendAckData(unsigned char *RES_DATA){
 219   1        
 220   1        
 221   1        unsigned char DATA_SEND[]= { 0x7E, 0x00,     0x02,  0x00,    0x00 ,      0x00,       0x7E};
 222   1      
 223   1        DATA_SEND[1]= RES_DATA[1];
 224   1        DATA_SEND[4]= RES_DATA[4];
 225   1        DATA_SEND[5]= CheckData(RES_DATA);
 226   1        
 227   1        SendData(DATA_SEND);
 228   1        
 229   1      }
 230          
 231          
 232          
 233          void DELAY_1MS() {
 234   1          unsigned char i, j;
 235   1      
 236   1          _nop_();
 237   1          _nop_();
 238   1          _nop_();
 239   1          i = 11;
 240   1          j = 190;
 241   1          do
C51 COMPILER V8.02   SMARTCAR                                                              02/01/2018 15:38:44 PAGE 5   

 242   1          {
 243   2              while (--j);
 244   2          } while (--i);
 245   1      
 246   1      
 247   1      }
 248          
 249          void DELAY_MS(unsigned int timeout)   //@11.0592MHz
 250          {
 251   1          int t = 0;
 252   1          while (t < timeout)
 253   1          {
 254   2              t++;
 255   2              DELAY_1MS();
 256   2          }
 257   1      }
 258          
 259          
 260          void ConnectServer() {
 261   1      
 262   1      
 263   1          UART_TC("+++\0"); // ÍË³öÍ¸´«Ä£Ê½
 264   1          DELAY_MS( 1500);
 265   1      
 266   1          UART_TC("AT\r\n\0");  // ATÖ¸Áî²âÊÔ
 267   1          DELAY_MS(1500);
 268   1      
 269   1          //UART_TC("AT+CWSTARTSMART\r\n\0"); // ¿ªÊ¼ÖÇÄÜÅäÍøÄ£Ê½
 270   1          //DELAY_MS(1000);
 271   1      //  LED = 0; // ÅäÍøÖ¸Ê¾µÆÁÁÆð
 272   1      //  DELAY_MS( 30000); // Á´½Ó³É¹¦
 273   1      
 274   1          //UART_TC("AT+CWSTOPSMART\r\n\0"); // ½áÊøÖÇÄÜÅäÍøÄ£Ê½£¬ÊÍ·ÅÄ£¿é×ÊÔ´(±ØÐë)
 275   1      //  DELAY_MS( 1000);
 276   1          //LED = 1; // ÅäÍøÖ¸Ê¾µÆÏ¨Ãð
 277   1      
 278   1          UART_TC("AT+CIPMUX=0\r\n\0");  // ÉèÖÃµ¥Á¬½ÓÄ£Ê½
 279   1          DELAY_MS(1500);
 280   1      
 281   1          UART_TC("AT+CIPSTART=\"TCP\",\"192.168.0.104\",4001\r\n\0");  // Á¬½Óµ½Ö¸¶¨TCP·þÎñÆ÷
 282   1          DELAY_MS( 3500);
 283   1      
 284   1          UART_TC("AT+CIPMODE=1\r\n\0"); // ÉèÖÃÍ¸´«Ä£Ê½
 285   1          DELAY_MS( 1500);
 286   1      
 287   1          UART_TC("AT+SAVETRANSLINK=1,\"192.168.0.104\",4001,\"TCP\"\r\n\0"); // ±£´æTCPÁ¬½Óµ½flash£¬ÊµÏÖÉÏµçÍ¸´
             -«
 288   1          DELAY_MS(1500);
 289   1      
 290   1          UART_TC("AT+CIPSEND\r\n\0");   // ½øÈëÍ¸´«Ä£Ê½
 291   1          DELAY_MS( 1500);
 292   1      
 293   1          CURRENT_LENGTH=0;
 294   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    559    ----
   CONSTANT SIZE    =    154    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      9      16
C51 COMPILER V8.02   SMARTCAR                                                              02/01/2018 15:38:44 PAGE 6   

   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
